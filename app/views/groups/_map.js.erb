
function findme(){
  navigator.geolocation.getCurrentPosition(initialize)
}

function initialize(location) {
  var currentlocation = new google.maps.LatLng(location.coords.latitude, location.coords.longitude)
  updateCurrentUser();
  updateGroupMarkers();

// ajax call to update the current users location
function updateCurrentUser(){
  var latitude = location.coords.latitude
  var longitude = location.coords.longitude
  var group_id = $("#map-canvas").attr("data-group-id")
  var user_id = $("#map-canvas").attr("data-user-id")
  var location_hash = {latitude: latitude, longitude: longitude}
  console.log(location_hash);
  $.ajax({
    url:"/groups/"+group_id+"/users/"+user_id,
    type: "get",
    dataType: "json",
    data: location_hash
  }).done(function(){
    console.log("in the done");
  })
}

var mapOptions = {
    center: currentlocation, // or the average of the users locations
    zoom: 15,
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'),
    mapOptions);

  var marker = new google.maps.Marker({
    position: currentlocation,
    map: map,
    title: 'Ryan Urie'
  });

// create markers for each user on the same map
function updateGroupMarkers(){
  var group_id = $("#map-canvas").attr("data-group-id")
  $.ajax({
    url: "/groups/"+group_id+"/users",
    dataType: "json",
    type: "get"
  }).done(function(response){
    console.log("ajax complete");
    for (var i = 0; i < response.length; i++){
      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(response[i].latitude, response[i].longitude),
        map: map,
        title: response[i].name
      });
    }
  })
}

function getupdatedlocation(){
    // console.log("updating location")
    navigator.geolocation.getCurrentPosition(function(location){
      var newlocation = new google.maps.LatLng(location.coords.latitude, location.coords.longitude)

      // var newlocation = new google.maps.LatLng(37.7952, 122.4028)
      if ( newlocation.k != currentlocation.k || newlocation.D != currentlocation.D) {
        marker.setPosition(newlocation);
        map.panTo(newlocation)
        updateCurrentUser();
        currentlocation = newlocation;
      }
    })
  }

  setInterval(getupdatedlocation, 3000)
  setInterval(updateGroupMarkers, 3000)
}


google.maps.event.addDomListener(window, 'load', findme);
